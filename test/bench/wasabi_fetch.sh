#!/bin/bash

set -e
set -x

SAMTOOLS="/install/samtools-1.18/samtools"
SLOW5CURL="/data/bonwon/slow5curl/slow5curl"
NTHREADS=128

REGION="/data/bonwon/slow5curl/test/data/raw/hundred_gene.random.hg38.bed"

# terminate script
die() {
	echo "$1" >&2
	echo
	exit 1
}

test -d rids || mkdir rids
test -d logs || mkdir logs
test -d out || mkdir out

TIME_FETCH () {
    NAME=$1
	DIRNAME=$(echo ${NAME} | awk -F"_" '{print $1}')

    rm -f reads.bam.bai

    { /usr/bin/time -v ${SAMTOOLS} view https://s3.ap-southeast-2.wasabisys.com/slow5curl/hg_bams/${NAME}/reads.bam -L ${REGION} -M | cut -f1 | sort -u > rids/${NAME}_rids.list; } 2> logs/${NAME}_sam.txt || die "Extraction failed. Exiting."
    /usr/bin/time -v ${SLOW5CURL} get https://s3.ap-southeast-2.wasabisys.com/slow5curl/hg_slow5/${DIRNAME}/${NAME}.blow5 -t ${NTHREADS} --list rids/${NAME}_rids.list -o out/${NAME}_reads.blow5 2> logs/${NAME}_curl.txt || die "Fetch failed. Exiting."

    echo "done for $NAME"
}

TIME_FETCH HG00735_1
TIME_FETCH HG00735_3
TIME_FETCH HG00735_5

TIME_FETCH HG00438_1
TIME_FETCH HG00438_3
TIME_FETCH HG00438_5
TIME_FETCH HG00621_1
TIME_FETCH HG00621_3
TIME_FETCH HG00621_5
TIME_FETCH HG00673_1
TIME_FETCH HG00673_3
TIME_FETCH HG00673_5

TIME_FETCH HG00741_1
TIME_FETCH HG00741_3
TIME_FETCH HG00741_5
TIME_FETCH HG01071_1
TIME_FETCH HG01071_3
TIME_FETCH HG01071_5
TIME_FETCH HG01106_1
TIME_FETCH HG01106_3
TIME_FETCH HG01106_5
TIME_FETCH HG01123_1
TIME_FETCH HG01123_3
TIME_FETCH HG01123_5
TIME_FETCH HG01175_1


TIME_FETCH HG01175_3
TIME_FETCH HG01175_5
TIME_FETCH HG01258_1
TIME_FETCH HG01258_3
TIME_FETCH HG01258_5
TIME_FETCH HG01358_1
TIME_FETCH HG01358_3
TIME_FETCH HG01358_5
TIME_FETCH HG01361_1
TIME_FETCH HG01361_3
TIME_FETCH HG01361_5
TIME_FETCH HG01891_2
TIME_FETCH HG01891_3

TIME_FETCH HG01891_4
TIME_FETCH HG01928_1
TIME_FETCH HG01928_3
TIME_FETCH HG01928_5
TIME_FETCH HG01952_1
TIME_FETCH HG01952_3
TIME_FETCH HG01952_5
TIME_FETCH HG01978_1
TIME_FETCH HG01978_3
TIME_FETCH HG01978_5
TIME_FETCH HG02148_1
TIME_FETCH HG02148_3

TIME_FETCH HG02148_5
TIME_FETCH HG02257_1
TIME_FETCH HG02257_3
TIME_FETCH HG02257_5
TIME_FETCH HG02486_1
TIME_FETCH HG02486_2
TIME_FETCH HG02486_3
TIME_FETCH HG02559_1
TIME_FETCH HG02559_2
TIME_FETCH HG02559_3
TIME_FETCH HG02559_5
TIME_FETCH HG02572_1
TIME_FETCH HG02572_3
TIME_FETCH HG02572_5
TIME_FETCH HG02622_1

TIME_FETCH HG02622_3
TIME_FETCH HG02622_5
TIME_FETCH HG02630_1
TIME_FETCH HG02630_3
TIME_FETCH HG02630_5
TIME_FETCH HG02717_1
TIME_FETCH HG02717_3
TIME_FETCH HG02717_5
TIME_FETCH HG02886_1
TIME_FETCH HG02886_3
TIME_FETCH HG02886_5
TIME_FETCH HG03453_1
TIME_FETCH HG03453_3
TIME_FETCH HG03453_5
TIME_FETCH HG03471_1

TIME_FETCH HG03471_3
TIME_FETCH HG03471_5
TIME_FETCH HG03516_1
TIME_FETCH HG03516_3
TIME_FETCH HG03516_5
TIME_FETCH HG03540_1
TIME_FETCH HG03540_3
TIME_FETCH HG03540_5
TIME_FETCH HG03579_1
TIME_FETCH HG03579_3
TIME_FETCH HG03579_5
